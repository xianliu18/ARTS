### SQL 语句是如何执行的

### 1, Mysql 基础架构
- Mysql 分为 Server 层和存储引擎层两部分；
  - Server 层包括连接器、查询缓存、分析器、优化器、执行器等；
  - 存储引擎层负责数据的存储和提取；

![mysql 的逻辑架构图](./images/mysql的逻辑架构图.webp)

#### 1.1 连接器
- 连接器负责跟客户端建立连接、获取权限、维持和管理连接；
  - 管理连接，权限验证；

#### 1.2 查询缓存
- Mysql 会以 `key-value` 对的形式缓存查询语句及结果，key 是查询的语句，value 是查询的结果；

#### 1.3 分析器
- 根据语法规则，判断输入的 SQL 语句是否满足 MySQL 语法规则；
  - SQL 的词法分析，语法分析

#### 1.4 优化器
- 优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序；
  - 生成 SQL 执行计划，索引选择；

#### 1.5 执行器
- 判断对指定表有没有执行查询的权限，若有权限，则调用存储引擎的接口，执行查询；
  - 操作存储引擎，返回查询结果；

### 2, InnoDB Buffer Pool(InnoDB 缓冲池)
- Buffer Pool 是 InnoDB 存储引擎层的缓冲池；
  - 缓存表数据和索引数据，避免每次访问都进行磁盘 IO，起到加速访问的作用；
- 预读机制：
  - 磁盘读写，并不是按需读取，而是按页读取，一次至少读取一页数据(一般是 4KB)；
  - 数据访问，通常都遵循“集中读写”的原则，使用一些数据，大概率会使用附近的数据，这就是所谓的“局部性原理”，它表明提前加载是有效的，确实能够减少磁盘 IO；
- Buffer Pool 采用变种LRU算法（最近最少使用），将LRU队列分成新生代（new sublist）和老生代（old sublist）两个区域，新生代用来存热点数据页，老生代用来存使用频率较低的数据页，默认比例为63:37
  - 将缓冲池分为老生代和新生代，进入缓冲池的页，优先进入老生代，页被访问且在老年代停留时间超过配置的阈值，才进入新生代，已解决预读失效和缓存污染的问题；
  - 预读失效：由于预读(Read-Ahead)，提前把页放入了缓冲池，但最终 MySQL 并没有从页中读取数据，称为预读失效；
  - 缓冲池污染：当某一个 SQL 语句，要批量扫描大量数据时，可能导致把缓冲池的所有页都替换出去，导致大量热数据被换出，MySQL 性能急剧下降，这种情况叫缓冲池污染；
- 参数：
  - `innodb_buffer_pool_size`：配置缓冲池的大小；
  - `innodb_old_blocks_pct`：老生代占整个 LRU 链长度的比例，默认是 37；
  - `innodb_old_blocks_time`：老生代停留时间窗口，单位是毫秒，默认是 1000；

### 3，Change Buffer
- 写缓冲是一种应用在**非唯一普通索引页**(non-unique secondary index page)不在缓冲池中，对页进行了写操作，并不会立刻将磁盘页加载到缓冲池，而仅仅记录缓冲变更(buffer changes)，等未来数据被读取时，再将数据合并(merge)恢复到缓冲池中的技术。写缓冲的目的是降低写操作的磁盘 IO，提升数据库性能；
  - 如果索引设置了唯一属性，在进行修改操作时，InnoDB 必须进行唯一性检查；
- 写缓冲场景：
  - 数据库大部分是非唯一索引；
  - 业务是写多读少，或者不是写后立刻读取；
    - 如果写后，立刻读取它；因为读取时，本来要进行页读取，相应页面就要入缓冲池，写缓存增加了复杂度；
- 参数：
  - `innodb_change_buffer_max_size`：配置写缓冲的大小，占整个缓冲池的比例，默认值是 25%；
  - `innodb_change_buffering`：配置哪些写操作启用写缓冲，可以设置成 `all/none/inserts/deletes`等；

<br/>

**参考资料：**
- [一条 SQL 查询语句是如何执行的](https://funnylog.gitee.io/mysql45/)
- [缓冲池(buffer pool)，这次彻底懂了](https://blog.csdn.net/shenjian58/article/details/93268633)
- [写缓冲(change buffer)，这次彻底懂了](https://blog.csdn.net/shenjian58/article/details/93691224)
- [Buffer Pool 和 Change Buffer](https://blog.csdn.net/weixin_39841589/article/details/109460679)